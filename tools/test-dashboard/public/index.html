<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DevSecOps • Test Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      .glow {
        box-shadow: 0 0 0.9rem rgba(99, 102, 241, 0.22);
      }
      .spin {
        animation: spin 0.9s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .shimmer {
        background: linear-gradient(90deg, rgba(99,102,241,0.05), rgba(99,102,241,0.25), rgba(99,102,241,0.05));
        background-size: 200% 100%;
        animation: shimmer 1.1s ease-in-out infinite;
      }
      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
    </style>
  </head>

  <body class="min-h-screen bg-slate-950 text-slate-100">
    <!-- OVERLAY EXECUTION -->
    <div
      id="overlay"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/70 backdrop-blur-sm"
      aria-hidden="true"
    >
      <div class="w-[92%] max-w-md rounded-2xl border border-slate-800 bg-slate-900/80 p-5 glow">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl border border-indigo-500/30 bg-indigo-500/10 flex items-center justify-center">
            <svg class="spin h-5 w-5 text-indigo-300" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="3" opacity="0.25"></circle>
              <path d="M21 12a9 9 0 0 0-9-9" stroke="currentColor" stroke-width="3" stroke-linecap="round"></path>
            </svg>
          </div>
          <div>
            <div class="text-sm font-semibold text-slate-100">Exécution en cours…</div>
            <div id="overlayTask" class="text-xs text-slate-400 mono">task: —</div>
          </div>
        </div>

        <div class="mt-4 h-2 w-full overflow-hidden rounded-full border border-slate-800 bg-slate-950/40">
          <div class="h-full w-full shimmer"></div>
        </div>

        <div class="mt-3 text-xs text-slate-400">
          Conseil : pendant que ça tourne, évite de spam click. Oui je te vois.
        </div>
      </div>
    </div>

    <div class="mx-auto max-w-7xl px-4 py-8">
      <header class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 class="text-3xl font-bold tracking-tight">
            DevSecOps • <span class="text-indigo-400">Test Dashboard</span>
          </h1>
        </div>

        <div class="flex items-center gap-2">
          <span id="meta" class="text-xs text-slate-400"></span>
          <button
            id="refresh"
            class="rounded-lg border border-slate-800 bg-slate-900 px-3 py-2 text-sm hover:bg-slate-800 glow"
          >
            Rafraîchir
          </button>
        </div>
      </header>

      <!-- TOP RESULT PANEL (visible direct) -->
      <section class="mt-6 rounded-2xl border border-slate-800 bg-slate-900/60 p-4 glow">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <div class="text-sm uppercase tracking-wider text-slate-400">Résultat</div>
            <div id="resultTitle" class="mt-1 text-lg font-semibold text-slate-100">
              Lance un test → on affiche tout ici.
            </div>
          </div>

          <div class="flex items-center gap-2">
            <div id="statusPill" class="hidden rounded-full px-3 py-1 text-xs font-semibold"></div>
            <button
              id="clear"
              class="rounded-lg border border-slate-800 bg-slate-950/40 px-3 py-2 text-sm hover:bg-slate-800"
            >
              Clear
            </button>
          </div>
        </div>

        <div class="mt-4 grid gap-3 md:grid-cols-4">
          <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-3">
            <div class="text-[10px] uppercase tracking-wider text-slate-400">Task</div>
            <div id="taskName" class="mt-1 mono text-sm text-slate-100">—</div>
          </div>

          <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-3">
            <div class="text-[10px] uppercase tracking-wider text-slate-400">Exit code</div>
            <div id="exitCode" class="mt-1 mono text-sm text-slate-100">—</div>
          </div>

          <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-3">
            <div class="text-[10px] uppercase tracking-wider text-slate-400">Durée</div>
            <div id="duration" class="mt-1 mono text-sm text-slate-100">—</div>
          </div>

          <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-3 md:col-span-1">
            <div class="text-[10px] uppercase tracking-wider text-slate-400">Résumé</div>
            <div id="summary" class="mt-1 text-sm text-slate-200">—</div>
          </div>
        </div>

        <div class="mt-4 rounded-xl border border-slate-800 bg-slate-950/40 p-3">
          <div class="flex items-center justify-between gap-3">
            <div class="text-[10px] uppercase tracking-wider text-slate-400">Logs (stdout + stderr)</div>
            <div class="text-[10px] text-slate-500">scroll</div>
          </div>
          <pre
            id="logs"
            class="mono mt-2 max-h-[320px] overflow-auto rounded-lg border border-slate-800 bg-slate-950/50 p-3 text-xs leading-relaxed text-slate-200"
          >Clique sur un bouton. Ici c’est la zone vérité.</pre>
        </div>
      </section>

      <!-- TASK LIST -->
      <section class="mt-6">
        <div class="flex items-center gap-2">
          <div class="h-px flex-1 bg-slate-800"></div>
          <div class="text-xs uppercase tracking-wider text-slate-400">Lancer un test</div>
          <div class="h-px flex-1 bg-slate-800"></div>
        </div>

        <div class="mt-4 grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="cards"></div>
      </section>

      <footer class="mt-10 text-center text-xs text-slate-500">
        Tip: DAST => <span class="mono text-slate-300">ENABLE_DAST=1</span> • SAST => <span class="mono text-slate-300">SONAR_TOKEN</span>
      </footer>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const cards = $("cards");
      const logs = $("logs");
      const summary = $("summary");
      const statusPill = $("statusPill");
      const taskName = $("taskName");
      const exitCode = $("exitCode");
      const duration = $("duration");
      const meta = $("meta");
      const refreshBtn = $("refresh");
      const clearBtn = $("clear");
      const overlay = $("overlay");
      const overlayTask = $("overlayTask");
      const resultTitle = $("resultTitle");

      const state = { tasks: [] };

      function msToHuman(ms) {
        if (ms < 1000) return `${ms}ms`;
        const s = Math.round((ms / 1000) * 10) / 10;
        return `${s}s`;
      }

      function pill(ok) {
        statusPill.classList.remove("hidden");
        statusPill.className = "rounded-full px-3 py-1 text-xs font-semibold";
        if (ok) {
          statusPill.classList.add("bg-emerald-500/15", "text-emerald-300", "border", "border-emerald-500/30");
          statusPill.textContent = "OK ✅";
        } else {
          statusPill.classList.add("bg-rose-500/15", "text-rose-300", "border", "border-rose-500/30");
          statusPill.textContent = "FAIL ❌";
        }
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }

      function smartSummary(taskId, out) {
        const text = out || "";

        if (taskId === "test" || taskId.includes("test")) {
          const suites = text.match(/Test Suites:\s+(.+)/i);
          const tests = text.match(/Tests:\s+(.+)/i);
          if (suites || tests) return [suites?.[0], tests?.[0]].filter(Boolean).join(" • ");
          return "Tests exécutés. Check les logs.";
        }

        if (taskId === "secrets") {
          const found = (text.match(/Found/gi) || []).length;
          return found > 0 ? `Signaux détectés: ~${found} (à vérifier).` : "Rien de suspect détecté (good).";
        }

        if (taskId === "sca") {
          const vuln = text.match(/Total:\s*(\d+)/i);
          if (vuln) return `Total findings: ${vuln[1]}`;
          if (/CRITICAL/i.test(text) || /HIGH/i.test(text)) return "HIGH/CRITICAL détecté → action.";
          return "Scan terminé.";
        }

        if (taskId === "sast") {
          if (/SONAR_TOKEN/i.test(text) && /missing/i.test(text)) return "SONAR_TOKEN manquant.";
          if (/ANALYSIS SUCCESSFUL/i.test(text)) return "Sonar OK.";
          return "SAST terminé.";
        }

        if (taskId === "dast") {
          if (/ENABLE_DAST/i.test(text) && /skipped/i.test(text)) return "DAST skippé (ENABLE_DAST=1).";
          if (/zap_report\.html/i.test(text)) return "Rapport généré: zap_report.html";
          return "DAST terminé.";
        }

        return "Exécution terminée. Lis les logs pour le détail.";
      }

      function setRunningUI(running) {
        document.querySelectorAll("button[data-task]").forEach((btn) => {
          btn.disabled = running;
          btn.classList.toggle("opacity-60", running);
          btn.classList.toggle("cursor-not-allowed", running);
        });

        if (running) {
          overlay.classList.remove("hidden");
          overlay.classList.add("flex");
          overlay.setAttribute("aria-hidden", "false");
        } else {
          overlay.classList.add("hidden");
          overlay.classList.remove("flex");
          overlay.setAttribute("aria-hidden", "true");
        }
      }

      async function fetchTasks() {
        const r = await fetch("/api/tasks");
        const data = await r.json();
        state.tasks = data.tasks || [];
        meta.textContent = `Node ${data.meta?.node || "?"} • cwd: ${data.meta?.cwd || "?"}`;
        renderCards();
      }

      function renderCards() {
        cards.innerHTML = "";

        const groups = [
          { title: "Sécurité", filter: (t) => (t.tags || []).includes("security") && !(t.tags || []).includes("pipeline") },
          { title: "Qualité & tests", filter: (t) => (t.tags || []).includes("quality") || (t.tags || []).includes("tests") },
          { title: "Phases pipeline", filter: (t) => (t.tags || []).includes("pipeline") },
        ];

        for (const g of groups) {
          const list = state.tasks.filter(g.filter);
          if (!list.length) continue;

          const block = document.createElement("div");
          block.className = "md:col-span-2 lg:col-span-3";

          block.innerHTML = `
            <div class="mt-2 mb-2 flex items-center gap-2">
              <div class="h-px flex-1 bg-slate-800"></div>
              <div class="text-xs uppercase tracking-wider text-slate-400">${g.title}</div>
              <div class="h-px flex-1 bg-slate-800"></div>
            </div>
          `;
          cards.appendChild(block);

          for (const t of list) {
            const card = document.createElement("div");
            card.className =
              "rounded-xl border border-slate-800 bg-slate-900/60 p-4 hover:bg-slate-900 glow transition";

            const tagBadges = (t.tags || [])
              .map((x) => `<span class="rounded-full border border-slate-700 px-2 py-0.5 text-[10px] text-slate-300">${x}</span>`)
              .join(" ");

            card.innerHTML = `
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold">${t.label}</div>
                  <div class="mt-1 text-xs text-slate-400">${t.description}</div>
                </div>
                <button
                  data-task="${t.id}"
                  class="rounded-lg bg-indigo-500/15 px-3 py-2 text-sm font-semibold text-indigo-300 border border-indigo-500/30 hover:bg-indigo-500/25"
                >
                  Lancer
                </button>
              </div>
              <div class="mt-3 flex flex-wrap gap-2">${tagBadges}</div>
              <div class="mt-3 text-xs text-slate-500 mono">task: ${t.task}</div>
            `;
            cards.appendChild(card);
          }
        }

        document.querySelectorAll("button[data-task]").forEach((btn) => {
          btn.addEventListener("click", () => runTask(btn.getAttribute("data-task")));
        });
      }

      async function runTask(id) {
        setRunningUI(true);
        statusPill.classList.add("hidden");

        overlayTask.textContent = `task: ${id}`;
        resultTitle.textContent = `Exécution: ${id}`;

        taskName.textContent = id;
        exitCode.textContent = "…";
        duration.textContent = "…";
        summary.textContent = "Ça tourne. Pas de panique.";
        logs.textContent = "Execution…\n";

        // Scroll direct vers le panel résultat (hyper visible)
        window.scrollTo({ top: 0, behavior: "smooth" });

        const started = Date.now();

        try {
          const r = await fetch("/api/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });

          const data = await r.json();
          const ended = Date.now();
          const d = data.durationMs ?? (ended - started);

          pill(!!data.ok);
          taskName.textContent = `${data.label || id}`;
          exitCode.textContent = String(data.exitCode ?? "—");
          duration.textContent = msToHuman(d);

          const combined = `${data.stdout || ""}\n${data.stderr || ""}`.trim();
          summary.textContent = smartSummary(id, combined);
          logs.innerHTML = escapeHtml(combined || "(no output)");

          resultTitle.textContent = `${data.label || id} — ${data.ok ? "OK ✅" : "FAIL ❌"}`;
        } catch (e) {
          pill(false);
          exitCode.textContent = "—";
          duration.textContent = msToHuman(Date.now() - started);
          summary.textContent = "Erreur côté dashboard.";
          logs.textContent = String(e?.message || e);
          resultTitle.textContent = "Erreur dashboard — FAIL ❌";
        } finally {
          setRunningUI(false);
        }
      }

      clearBtn.addEventListener("click", () => {
        statusPill.classList.add("hidden");
        resultTitle.textContent = "Lance un test → on affiche tout ici.";
        taskName.textContent = "—";
        exitCode.textContent = "—";
        duration.textContent = "—";
        summary.textContent = "—";
        logs.textContent = "Zone logs nettoyée. Propre.";
      });

      refreshBtn.addEventListener("click", fetchTasks);

      fetchTasks();
    </script>
  </body>
</html>